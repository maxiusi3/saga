## 总体思路
- 为评论区建立可扩展的“发布 → 展示 → 查看 →选入故事”的完整闭环，保证在弱网/移动端下仍可稳定工作。
- 前端模块化：评论发布（Composer）、评论列表（Feed）、图片查看器（Viewer）、上传管理（Upload Manager with Worker & resumable）
- 后端扩展：交互路由支持最多9张图片、返回已保存的附件；新增选入故事标记；错误重试友好

## 数据与API
### 交互表（interactions）
- 字段：`attachments jsonb`（数组，每项：`{id,url,thumbUrl,mime,size,added_to_story:boolean}`）
- 约束：最多9张、类型限制`image/jpeg|image/png|image/gif`、单张≤5MB

### 路由调整
- `POST /api/stories/:storyId/interactions`：
  - 请求体：`{ type:'comment', content:string, attachments:Array<AttachmentInput> }`
  - 服务端：校验、写入、生成响应；返回完整交互对象（含`attachments`）用于前端乐观合并
- `GET /api/stories/:storyId/interactions`：
  - 排序：`created_at DESC`（时间倒序）
- `POST /api/stories/:storyId/images/select-from-interactions`：
  - 追加所选图片到故事，并将相应附件打标 `added_to_story = true`

## 前端模块设计
### 1) CommentComposer（评论发布）
- 角色检查：storyteller & facilitator 可用；无权限时隐藏
- 输入限制：
  - 文本支持换行（`Textarea`），为空且无图片时禁用“发布”按钮
  - 图片选择（`<input multiple accept='image/jpeg,image/png,image/gif'>`），允许1-9张（累加）
- 进度与预览：
  - 每张显示缩略图、右上角删除按钮；删除后更新计数
  - 进度条：单张/总体（例如每张顶部细进度，整体底部进度）
- 断点续传：
  - Upload Manager（前端）：将大图切片（1MB chunks），以“分块顺序上传、失败分块重试（指数退避）”策略提交到后端缩略图上传API；使用IndexedDB记录上传进度（fileId、uploadedChunks），刷新后可继续
  - 失败重试：最多3次；失败提示并保留状态
- 缩略图生成（Web Worker）：
  - 使用`createImageBitmap` + `OffscreenCanvas`，生成1:1正方形缩略图（中心裁剪），减少主线程阻塞
- 发布流程：
  - 组合文本+已成功上传的图片附件；调用`POST /interactions`，收到响应后将新评论乐观插入列表顶部；清空Composer状态

### 2) InteractionsFeed（评论展示）
- 单条评论卡片：头像、昵称、时间戳（右上角）、正文（pre-wrap）、图片网格（3列，最多9张，固定1:1）
- 图片点击打开Viewer；若`added_to_story`为true，缩略图显示绿色边框或角标
- 列表排序：倒序（最新在上）

### 3) ImageViewer（查看器）
- UI：黑色半透明蒙层、居中显示原图（contain）、右上角关闭
- 底部页码（如 3/5）
- 左右切换箭头；移动端手势（触摸滑动左右）
- storyteller额外显示“添加到故事”按钮；点击调用`select-from-interactions`，成功后刷新卡片并为该附件加标

### 4) 状态管理与持久化
- Composer：本地状态+IndexedDB（分块进度）+localStorage（未发布的附件列表，在极端情况下回退）
- Feed：首次加载后仅在用户显式操作（发布成功、选入故事成功）或标签页从不可见→可见时刷新；避免空白点击触发重载

## 交互细节与动效
- 预览缩略图添加/删除：平滑过渡（淡入淡出/缩放）
- 上传进度：条形动画、失败红色提示；重试按钮或自动重试提示
- Viewer切换：滑动过渡、手势事件（pointer/touch）
- 响应式：移动端3列网格改为2列，小屏Viewer按钮增大点击面积

## 兼容与错误处理
- 类型与大小校验在前后端均执行
- 网络异常：分块失败重试，整体失败保留已完成分块；用户可以稍后继续
- 发布失败：文本与已上传附件不丢失，保留在Composer中；按钮恢复可点击

## 开发拆解
1) 后端
- 扩展 `POST /interactions` 返回完整`attachments`
- `GET /interactions` 改为倒序，并保留用户资料合并
- `select-from-interactions` 将选中的附件追加到故事，并返更改后的`attachments`（打标）

2) 前端
- 新建 Upload Manager（含 Worker，与 IndexedDB 存储）
- Composer：上传、预览、删除、禁用规则、发布流程
- Feed：倒序、卡片样式、added标签显示
- Viewer：页码、左右切换、手势、添加到故事按钮
- 刷新策略：移除激进的focus刷新，改为可见性变化或显式刷新

3) i18n
- 新增文案键：上传中/失败、删除图片、清空、添加到故事、页码指示等（`interactions.json`）

4) QA验证
- 桌面与移动端分别测试：
  - 仅文字/仅图片/图文混合；1张、9张；多次选择累加
  - 弱网/断网重连；中断后续传；刷新后继续上传
  - 发布后立即出现，排序正确；添加到故事标记显示

## 交付里程碑
- M1：后端API返回与打标完善（倒序、attachments完整返回）
- M2：前端Upload Manager + Worker + Composer（进度/预览/删除/累加/禁用）
- M3：Feed卡片与Viewer（页码/手势/添加到故事）
- M4：QA覆盖与问题修复；性能优化（Worker与IndexedDB）

请确认以上方案，我据此开始实现。