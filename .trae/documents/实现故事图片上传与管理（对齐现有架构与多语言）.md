## 当前架构综述
- 数据模型与数据访问
  - 共享类型：`packages/shared/src/types/story.ts` 与 `packages/shared/src/types/image.ts`，已定义 `StoryImage`/`InteractionImage` 及校验常量。
  - Web 端服务：`packages/web/src/lib/stories.ts`、`packages/web/src/lib/interactions.ts`，通过 Supabase 访问数据与调用 API。
  - Supabase 客户端：`packages/web/src/lib/supabase.ts`，提供客户端、服务端 Admin、环境变量读取。
- API 路由
  - 故事图片：`GET/POST/PATCH/DELETE` 路由已存在，如 `packages/web/src/app/api/stories/[storyId]/images/route.ts`、`.../reorder/route.ts`、`.../set-primary/route.ts`。
  - 片段图片上传：`POST /api/stories/:storyId/transcripts/:transcriptId/images`。
  - 评论图片上传：`POST/DELETE /api/interactions/:interactionId/images`。
- 前端 UI
  - 上传组件：`packages/web/src/components/images/ImageUploader.tsx` 支持拖拽/文件选择、校验、客户端压缩与预览。
  - 相册组件：`packages/web/src/components/images/ImageGallery.tsx` 使用 `next/image` 响应式展示、主图设置、拖拽排序、灯箱 `ImageLightbox`。
  - 整合页面：`packages/web/src/components/stories/story-detail-page.tsx` 已接入图片查询、从评论复制、主图/删除/重排；`TranscriptEditModal.tsx` 支持编辑与图片管理。
- 存储与工具
  - Supabase Storage 封装：`packages/web/src/lib/storage-service.ts`（路径生成、上传/删除、签名 URL、复制）。
  - 图片工具：`packages/web/src/lib/image-utils.ts`（校验、预览、Canvas 压缩）。
- 多语言系统
  - 使用 `next-intl`：Provider 在 `packages/web/src/app/[locale]/layout.tsx`，消息位于 `packages/web/public/locales/{locale}`；组件通过 `useTranslations('namespace')` 使用键。

## 目标与范围
- 严格对齐需求与设计文档，实现：
  - 前端图片上传（拖拽/选择器）、校验与压缩、进度与重试、响应式相册与灯箱。
  - 后端上传处理、存储与数据库关联、签名 URL、排序/主图设置/删除、从评论复制。
  - 生成 400×400 缩略图与水印（派生需求），并记录/验证版权信息。
  - 全面多语言化 UI 文本与错误提示；图片元数据支持多语言描述字段。
  - CDN 分发与缓存策略，确保加载性能。
  - 完整单测/集成/E2E 验证与预发布多语言兼容性核验。

## 数据库迁移（新增/变更）
- `story_images` 与 `interaction_images` 增加：
  - `thumbnail_path TEXT`（缩略图存储路径）。
  - `description_i18n JSONB DEFAULT '{}'`（多语言描述，键为 locale）。
  - `copyright_verified BOOLEAN DEFAULT FALSE`（版权验证结果）。
  - 索引：`(story_id, order_index)` 已有；补充 `thumbnail_path` 非唯一即可。
- RLS 无需变更（字段新增不影响访问策略）。

## 后端 API 扩展与修正
- 片段图片上传 `POST /api/stories/:storyId/transcripts/:transcriptId/images`
  - 服务端校验：格式/大小/数量（沿用常量），新增服务端维度提取与版权验证。
  - 生成缩略图：使用 `sharp` 生成 400×400，居中裁剪，质量 80；可选文字/图像水印（派生需求）。
  - 写库：保存原图 `storage_path`、缩略图 `thumbnail_path`、`width/height`、`description_i18n` 初始 `{}`、`copyright_verified`。
  - 响应：返回两条签名 URL（原图/缩略图）。
- 评论图片上传 `POST /api/interactions/:interactionId/images`
  - 同步上述逻辑（维度、缩略图、水印、版权）。
- 从评论复制到故事 `POST /api/stories/:storyId/images`
  - 请求体字段修正为 `interaction_image_ids`（与设计一致）。
  - 复制同时派生缩略图（如源有则复用；无则服务端生成），并继承 `width/height`、版权标记。
- 排序/主图/删除
  - 保持现有接口不变；删除同时清理缩略图文件；若删除主图，自动指派下一张（已实现）。
- CDN 与缓存
  - 返回签名 URL 基础上，针对缩略图设置更长缓存（客户端 `next/image` 负责）；如需要，增加代理路由设置 `Cache-Control`。

## 前端实现与对接
- ImageUploader
  - 保留现有拖拽/选择器、校验与 Canvas 压缩；
  - 新增上传进度与失败重试：以文件队列状态管理，失败项可单独重试；API 不提供进度时以本地阶段进度模拟（压缩→上传→完成）；
  - 所有文案键来自 `images.json`，补齐 `imagesSelected`、`loadError`、`setting/deleting/reordering/adding` 等键使用。
- ImageGallery
  - 列表使用缩略图 URL（更快、更省流），灯箱使用原图 URL；
  - 保留拖拽排序/主图/删除逻辑；错误与加载状态使用多语言键。
- CommentImageSelector
  - 修正调用体为 `{ interaction_image_ids }`；保留多选与批量添加逻辑。
- TranscriptEditModal / StoryDetailPage
  - Modal 传入 `onUploadImages`（调用片段图片上传 API，逐文件上传）；`onDeleteImage` 调用故事图片删除；
  - 详情页调用 `fetch /api/stories/:storyId/images` 展示缩略图；点击进入灯箱显示原图。
- 多语言
  - 将页面/组件内英文硬编码替换为 `useTranslations` 键：如 `Back to Stories`、`Share`、`Export`、`Reply` 等；
  - 新增图片相关键：`images.imagesSelected`、`images.loadError`、上传阶段动词等；错误统一映射 `errors.*`。

## 图片版权验证与水印
- 版权验证
  - 读取 EXIF（如 `Artist`、`Copyright`、`Software`）与基础启发式（像素过小/格式异常）；
  - 将结果存入 `copyright_verified`；若未验证通过，可在 UI 标记并支持人工确认。
- 水印添加
  - 在缩略图生成时可选叠加水印文字（`© {storyteller or project name}`）或图标；
  - 水印样式国际化（字体/位置可配置，但文案走 i18n）。

## CDN 分发与缓存策略
- `next.config.js` 增加 Supabase 域名到 `images.domains` 或使用 `remotePatterns`（由 `NEXT_PUBLIC_SUPABASE_URL` 解析 host）；
- 优先使用 `next/image` 的优化与懒加载；保留签名 URL 安全访问；
- 可选：引入简易 Service Worker 缓存缩略图（`performance-utils.cachingUtils`）。

## 测试计划
- 单元测试
  - 前端：`image-utils` 校验/压缩、Uploader 状态管理（含重试）。
  - 后端：缩略图生成、水印叠加、EXIF 解析与错误路径；API 请求体验证（格式/大小/数量）。
- 集成测试
  - 交互流：片段上传、评论上传、从评论复制、主图设置、排序与删除；返回 URL 与数据库记录一致性。
- E2E 测试
  - 录制页上传图片 → 审核页/详情页展示相册；评论上传 → 选择添加到故事；灯箱导航与多语言文案检查。

## 迁移与发布
- 迁移：新增列 SQL（与现有 `supabase/migrations` 保持一致）并在预发布环境执行。
- 配置：`next.config.js` 更新图片域名与国际化消息补充；确保 `NEXT_PUBLIC_SUPABASE_URL/ANON_KEY` 正确。
- 预发布验证：
  - 全部支持语言（`en/zh-CN/zh-TW/ja/ko/es/fr/pt`）进行页面巡检；
  - 缩略图生成、签名 URL 访问、相册加载性能与缓存效果；
  - 版权标记与水印显示符合预期。

如同意以上方案，我将开始实施：数据库迁移→后端路由增强→前端组件改造→多语言键补齐→测试用例补充，并在预发布环境完成联调与兼容性验证。