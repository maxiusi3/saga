## 概述
- 扩展现有 Next.js + Supabase 项目，支持：
  - 子故事（续写）形成播放列表，按创建时间排序。
  - 故事段与评论的图片上传（最多 6 张/评论，单张 ≤ 5MB），并生成缩略图供浏览导航。
  - 讲述者可从评论中选图，加入故事的图片组，caption 为评论链接。
  - 保存录制后跳转到故事详情页而非故事列表。
  - 多语言文案补齐与新文案接入。

## 数据模型
- `stories` 表：新增
  - `parent_story_id`（可空，引用 `stories.id`）用于子故事关联。
  - `images`（JSON[]）：`{ url, thumbUrl, source: 'segment'|'comment', source_id, caption }`。
- `interactions` 表：新增
  - `attachments`（JSON[]）：结构同上；用于评论/追问的图片附件。
- 排序：播放列表按 `created_at ASC`。

## 存储与缩略图
- 使用 Supabase Storage：
  - 原图路径：`images/stories/<storyId>/` 与 `images/interactions/<interactionId>/`。
  - 缩略图：与原图同目录，文件名追加 `-thumb`（如 `xxx.jpg` → `xxx-thumb.jpg`）。
- 缩略图生成：
  - 新增后端 API（Next.js Route）使用 `sharp` 统一生成缩略图（例如宽度 320px，质量 75%），上传原图与缩略图并返回 URL。
  - 前端统一调用该 API 完成上传，复用 `StorageService`，保持类型/大小校验与错误处理。
- 公开访问：保持桶为公开读；仅限项目参与者知道地址范围。

## 后端 API
- 故事创建：扩展 `POST /api/projects/[id]/stories`
  - 接受 `parent_story_id` 与可选 `images`（来自录制后的编辑区）。
- 交互写入：扩展 `POST /api/stories/[storyId]/interactions`
  - 支持多图附件（≤6），落库 `attachments`，返回含缩略图的交互对象。
- 选图入故事：新增
  - `POST /api/stories/[storyId]/images/select-from-interactions`：传入 `interaction_id[]` 和选中图片的索引/ID，追加到 `stories.images`，`caption` 设为评论链接，`source='comment'`。
- 校验与限制：
  - 文本 ≤ 3000 字；图片数量与体积在路由层校验。

## 前端流程
- 录制续写：
  - 在故事详情页增加“录制后续故事”按钮（显示父故事标题），跳转录制页并携带 `parent_story_id`。
  - 录制页支持图片上传与预览（调用上传 API 返回原图与缩略图），提交后包含 `images`。
  - 点击“保存”后，路由跳转至 `stories/[storyId]` 详情页。
- 故事详情：
  - 顶部显示原始故事信息，下面渲染播放列表（原始 + 子故事），每项可展开查看文本与图片组。
  - 新增“评论补充图片”区：展示评论中的图片缩略图；讲述者可勾选并“选入故事”。
- 评论与追问：
  - `StoryInteractions` 增加图片上传控件（多图、预览、删除），限制 6 张与 5MB；发布后列表显示图片缩略图。

## 组件与服务
- `StorageService`：新增 `uploadImageWithThumb(file, folder)`，封装到后端缩略图上传 API。
- `StoryService`：
  - `createStory({ parent_story_id, ... })` 支持续写。
  - `updateStoryImages(storyId, add[], remove[])` 用于追加/移除图片。
- 播放器与详情：
  - 播放器支持“多段音频”列表（按创建时间），每段展示对应文本与图片缩略图。

## i18n 文案
- 命名空间：`stories` 与 `interactions` 增加新键（续写入口、播放列表、图片上传、选入故事、来源标签、缩略图提示、大小与数量限制、保存跳转提示）。
- 补齐缺失翻译：扫描 `public/locales/<locale>/*.json`，对所有目标语言补齐新旧缺失键；`request.ts` 已包含命名空间维持不变。

## 权限与安全
- 讲述者可创建续写与选图；facilitator 与 storyteller 可上传评论图片；owner 仍不可发言。
- 桶公开读；仅存非敏感图片；统一大小/数量限制。

## 路由跳转修改
- 录制页保存后改为 `router.push(/[locale]/dashboard/projects/[id]/stories/[newStoryId])`。

## 验证
- API 集成测试：续写创建、评论图片上传、选图入故事成功与边界用例（数量/体积/长度）。
- 前端交互测试：播放列表渲染、图片预览/选入/跳转行为。
- 兼容性：现有录制与故事浏览流程保持不变。

## 待确认
1) 图片格式：默认支持 `jpg/png`，是否需要 `webp`？
2) 缩略图规格：是否接受“宽 320px，质量 75%”？如需更大/更小请指示。