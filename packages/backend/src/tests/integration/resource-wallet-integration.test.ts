})
})
    })
  erationsInitial + oprThan(8) // BeGreategth).toions.lenllTransactect(a      expUser.id)
istory(testnHactioice.getTranseWalletServrcit Resou awasactions =st allTranon    c
  recordedctions are ansatr Verify all  //
      1 = 1
 // 2 -(1)s).toBeeatlerSelce.storytt(finalBalan     expec = 3
  + 1/ 3 - 1 /.toBe(3)atorSeats)ce.facilitinalBalan    expect(f+ 1 = 5
   // 5 - 1 rs).toBe(5)ctVoucheance.projealBal(finexpectd)
      e(testUser.ialanc.getWalletBceeWalletServit Resourcnce = awailBalananst ficoate
      l stify fina  // Ver}

    on()
       operatiwait
        aerations) { op oferation op  for (consttially
    tions sequenoperaute    // Exec   ]

      ')
ect-1', 'projfund testRe 1, '',eator_s 'facilitater.id,stUs(teurcesso.refundRetServicealleesourceW() => R     t-1'),
   .id, 'projecstUserSeat(telertelsumeStoryce.conletServiceWal => Resour    ()  
  '),ase', 'Test1, 'purch', oucheroject_vid, 'prr.es(testUsesource.addRervicetSerceWall> Resou    () ='),
    oject-1d, 'prtUser.iat(tesrSemeFacilitatorvice.consulletSe> ResourceWa      () =ct-1'),
  'projeer.id, cher(testUstVoujecconsumeProervice.WalletSesource   () => R = [
     ionsperatst o
      con operations a series of // Perform

     r.id)estUse(tetBalance.getWallalletServiceurceW await ResolBalance =nitia i
      const() => { async ions', operats multipleoscronsistency ad maintain c   it('shoul() => {
 zation', Synchronit e('Walle
  describ)
  })
)
    }lsefa5)).toBe(Amount(1.ice.validateletServeWalurcso(Re  expectfalse)
    oBe(nt(-1)).tlidateAmou.vaerviceWalletSurcesoxpect(Re
      eoBe(false)nt(0)).tAmouce.validatealletServirceWResouct(     expealse)
 (f)).toBenvalid_type'ype('iceTlidateResoure.valetServic(ResourceWal    expectervice
  in the slidation caught by vas should be // Thi

           }nt: 1
 amou       as any,
  _type' 'invalidsourceType:     re.id,
   User testId:user   {
      est =ptionRequurceConsumsot: Reues reqonst {
      cync () =>ts', asand amounes ce typid resourandle inval huld('sho
    it})
ound')
    Wallet not fror).toBe('result.erexpect(se)
      toBe(fal.success).ult expect(res
     d)
ect.itestProjallet.id, WithoutWoucher(usertVecmeProjervice.consuurceWalletSeso Rult = awaitconst res
      })
  id'
    th-llet-auerId: 'no-waidhProv aut   l',
    er: 'emaiauthProvid     
   llet User', Wae: 'Noam   n
     le.com',exampllet@nowa: '       emailcreate({
 odel.rMUset = await WalleserWithout   const u
   lletwithout a waeate a user 
      // Cr=> { async () y', gracefullnt wallet-existedle nonshould han it(')

   pdate
    }lUte = originaupdalletModel.ResourceWaod
      th original meestore
      // Runchanged
ld remain houe(5) // S.toBctVouchers)jee.prolancba expect()
     stUser.idteBalance(allettWervice.getSurceWalleait Resoalance = aw  const b   nged
 unchabalance is rify   // Ve   
 ources')
nsume resiled to coBe('Fatoror).ult.eresct(rxpe   ee)
   Be(falsccess).toult.supect(res    ex  )

oject.idr.id, testPr(testUseojectVoucher.consumePrerviceletSrceWalait Resouawesult =     const r

  e error'))('DatabasrorErlue(new jectedVamockRejest.fn().date = etModel.uprceWallesou
      RdatelletModel.up= ResourceWate riginalUpdat o   consaction
   ing trans error durdatabasea ck Mo
      // ) => {ly', async ( gracefulures failansaction database tr handleshould   it('=> {
 es', () d Edge Casng anrror Handli describe('E)

     })
  }
efined().toBeDdated)lastUp(stats.    expect
  BeDefined()).toatedAtt(stats.creexpec     e)
 )).toBe(truansactionsentTrtats.recrray(s.isAexpect(Array
      ined()oBeDefions).ttTransactats.recen  expect(stan(0)
    GreaterThalue).toBeotalVtats.t  expect(s
    
     })changed
 : 2  // unllerSeatsryte
        sto2, // 3 - 1ts: eatatorSacili    f - 1
    , // 5 4Vouchers:roject p
       Equal({).torentBalance.curexpect(stats    er.id)

  ats(testUstStlleetWa.grviceWalletSe Resourceaitstats = aw     const t.id)

 stProjecUser.id, terSeat(testacilitatoce.consumeFServiWalletit Resource
      awaoject.id)id, testPr(testUser.cherojectVounsumePrtService.coeWalleResourc  await tions
    pera oome/ Perform s
      / => { ()ics', asynctatistet s wallccurate provide ashould  it('    })

  2)
eLength(Hav).tonsactionsdTraxpect(limite   e  })
   : 2
          limit{
  er.id, (testUsHistorysactionetTranice.getServeWallt Resourcaiactions = awitedTrans   const lim  tions
 sacan limited tr     // Get
 ue)
.toBe(troucher')) 'project_v===ourceType => t.res.every(t actionsTransect(voucherexp)
           }oucher'
  'project_veType:ourc    res
    .id, {y(testUserionHistortTransactetService.gerceWallesou = await Rsactions voucherTran  const    tions
saccher tran project vouGet only     // 

 toBe(true)e')).um'consType === ransaction(t => t.t.everyctionsransaconsumptionT     expect(
       })consume'
 'Type: transaction {
       ser.id,ory(testUHistTransactionervice.getrceWalletSit Resoutions = awaactionTransnsumpst coon   ctions
   ac transumptiononly const    // Ge
   rThan(0)
eGreateoBngth).tnsactions.lect(allTra
      expeid)stUser.istory(tesactionHgetTranlletService.ceWaesourit R= awasactions st allTran    con
  ionsctll transa    // Get a
  se')
st purcha 'Techase',1, 'pur_voucher', ectr.id, 'projs(testUseesourceervice.addRalletSourceWit Resawaid)
      roject. testPr.id,sestUrSeat(teatoilitumeFacvice.consetSerResourceWallwait 
      act.id)testProjeestUser.id, cher(tjectVounsumeProe.coServiclleteWaurceso  await Rons
    atis operm variou // Perfor
     sync () => {iltering', ah fy witistorion he transactaccuratd provide ('shoul
    it () => {lytics', and Anastoryction HiTransa  describe('
  })

   })toBe(0)
 s).oucherctVrojeBalance.pect(final)
      expser.idnce(testUWalletBalace.getvietSerceWallwait Resour analBalance =t fions
      cld be 0balance shou// Final 
      1)
nt).toBe(failureCouxpect(      eoBe(1)
nt).tuccessCouect(s  expngth

    success).leter(r => !r.sults.filnt = reoueCconst failur
      lengthess).r => r.succr(ilte= results.fcessCount st suc   conld fail
   shouone eed, cce should su/ On
      /s)
omisenPrumptionsomise.all(co = await Prtsesulst ron  c   

 )
      ]t-2't-projecrrencu 'constUser.id,r(terojectVouche.consumePlletServiceesourceWa   R1'),
     t-jecprooncurrent-tUser.id, 'cher(teseProjectVouce.consumetServicallResourceW       [
 es = ptionPromisconsum     const for one)
 il fald tly (shoucurrenouchers connsume 2 vy to co/ Now tr /

           }{i}`)
project-$`setup-ser.id, er(testUctVouchumeProjenservice.coeWalletSsourc   await Re    {
  +)< 4; i+et i = 0; i for (lly 1
      ave onlechers to e 4 vout consum   // Firs    () => {
ncces', asycient resourinsuffiations with ent operrrndle concu'should ha
    it(s
    })
ionsumpt + 3 conal1 initi) // (4Lengthons).toHaveansacti   expect(tr })
   her'
     ect_voucrojrceType: 'pou       resr.id, {
 UseHistory(testactionce.getTransalletServiourceW await Resnsactions =tra     const )
 consumptionsnitial + 3 ns (3 iansactiootal truld have 6 t    // ShooBe(2)

  chers).tprojectVoualBalance.ct(fin
      expeid)stUser.lance(teetWalletBae.grvictSeourceWalleResit ance = awaalonst finalB    c (5 - 3)
  should be 2balance // Final    
   })

      (true)oBeess).tresult.succ   expect( => {
     h(result.forEacultsesers
      rhave 5 vouch since we cceeduld su  // All sho    

ses)mptionProminsu(co Promise.allait = awsultsconst re )

      }`)
     ${i, `project-ider.Usucher(testjectVoonsumePro.cServicelletrceWa Resou> 
       }, (_, i) =: 3 engthm({ ly.froes = ArraPromisumptionst conscon      ests
qusumption rent con concurreipleeate mult   // Cr) => {
   ly', async (correctonsumption esource c rncurrentle could hand
    it('sho => {, ()ions'rrent Operat'Concuribe(
  desc  })
  })
  h(3)
aveLengtns).toHTransactiorchaseexpect(pue')
      rchaspe === 'puransactionTy=> t.tt r(tections.filllTransaactions = aseTransonst purcha
      cd)stUser.iry(tectionHistoe.getTransaWalletServicource Resawaitions = ctst allTransad
      con loggeactions arefy all trans Veri     //+ 2

 e(4) // 2 ts).toBllerSeastorytelance.t(updatedBa
      expec3 + 25) // eats).toBe(orSitatance.facilt(updatedBal
      expec// 5 + 16) e(chers).toBectVouBalance.projct(updated     expe
 r.id)e(testUseancWalletBal.getviceereWalletSourcawait Resnce = Balanst updatedco
      updatedances are ify all bal     // Ver

     ])
  ler Seats')rytelPackage: Sto, 'urchase', 2, 'pseat'teller_, 'storyer.ides(testUsurcice.addResolletServourceWa    Ress'),
    tor Seatilitaackage: Fac, 'P'purchase'seat', 2, tor_ilitar.id, 'fac(testUseurcesce.addResotServiourceWalle   Reser'),
     oject Vouchkage: Pr'Pac', purchaseucher', 1, 'ect_void, 'projUser.rces(testaddResouletService.ceWalsour
        Rel([ise.alit Prom   awae
   asch package purte full   // Simula   r.id)

stUseBalance(telletice.getWalletServourceWa = await Resalancest initialB{
      connc () => asye', ge purchasin packaditions ource adultiple reshandle mld shou

    it('e')
    })urchasa Package Pe('Sagption).toB?.descriransactionaseTpurch    expect(  toBe(2)
on?.amount).ansactichaseTrexpect(pur
      d()toBeDefinetion).nsacrchaseTraexpect(pu     se')
 == 'purchaType =ion t.transact =>ions.find(tction = transaransactaseTrch    const pu     
     })
 oucher'
   ct_vprojeType: 'resource        
er.id, {stUsory(teonHistactiice.getTransletServrceWalwait Resoutions = at transac     consis logged
 nsaction urchase trafy peri
      // V(7)
rs).toBeectVouche.projBalancepect(updatedd)
      exer.ice(testUsalletBalanvice.getWlletSerResourceWae = await pdatedBalanc    const ud
  pdatelance is ufy ba     // Veri + 2

 ) // 5).toBe(7alancet.remainingBesul expect(addR   (true)
  ).toBeccessaddResult.suexpect(
            )
hase'
 PurcSaga Package        '
hase',    'purc
    
        2,oucher',_vproject      ',
  stUser.id    te  urces(
  dResoervice.adetSceWall Resour = awaitsultdRenst adse
      corchae pu packagomes as if frresourc/ Add   /
    d)
ser.ilance(testUetWalletBarvice.galletSerceWawait Resoualance = st initialB      con) => {
ed', async (haspurce is n packagources whed resould adit('sh     {
) =>Flow', (hase ackage Purc('P
  describe
  })
    })e(1)
ount).toBamransaction?.ect(refundTexp     ()
 ed.toBeDefinransaction)refundT   expect(
   'refund')=== tionType sac=> t.trant ons.find(= transactisaction  refundTran    const      
    })
   at'
 secilitator_'faceType:  resour   .id, {
    ory(testUseronHisttiTransace.getalletServicesourceWns = await Rnsactiost trad
      conogge is lansaction trefund/ Verify r

      /(3)s).toBetatorSeat.faciliinalBalance(fpect)
      exr.idance(testUselletBale.getWaWalletServicsource= await Ree finalBalanct    consd
   is restorey balance  Verif     //)

 ce).toBe(3lanmainingBaResult.rect(refundpe ex     oBe(true)
cess).tult.succt(refundRes
      expe  )

    idject.    testPro',
    ejectednvitation r  'I  1,
           or_seat',
  'facilitat
       testUser.id,     
   ndResources(efuce.rWalletServit Resource= awaidResult const refun     seat
  / Refund the   /(2)

   Be).totsilitatorSeaion.facnsumpteAfterCoalanc  expect(br.id)
    ce(testUseanalletBalvice.getWceWalletSerawait Resourion = onsumptanceAfterC bal  const      
)
    roject.idd, testPUser.istatorSeat(temeFacilitce.consualletServisourceWwait Ret
      alitator sea a faciirst consume
      // F () => {ed', async rejectvitation isn inheund seat wld refit('shou

        })e(1)
eats).toBllerSoryteedBalance.st(updatect   exper.id)
   Usce(testanetWalletBalrvice.gurceWalletSeeso Rawaitance = edBalupdat  const pdated
    e is urify balanc // Ve   Be(1)

  gBalance).toinmainret.ect(resul  exp  )
  uetroBe(ccess).tsuult.esect(r  exp

    id)t.testProjecestUser.id, at(tytellerSe.consumeStorlletServiceesourceWat Result = awai r const     r seat
orytellensume st  // Co   
 toBe(2)
rSeats).e.storytellealancinitialBect(xp  e   d)
 e(testUser.iancetBalice.getWalletServrceWallou= await Reslance alBaonst initi    c () => {
   asyncller',storyteting  invi whenr seate storytellesumonld c  it('shou })

  (-1)
   mount).toBesaction?.aTranconsumption  expect(ed()
    toBeDefinction).ansansumptionTr  expect(coume')
     === 'consctionType => t.transations.find(ttransacn = nsactiomptionTraconst consu     n
      
  consumptio 1l +initia) // 1 (2HaveLengthctions).toxpect(transa  e         })
at'
 _seitatorype: 'facilrceT   resoud, {
     er.istory(testUsctionHiTransatService.getllet ResourceWaains = awtionst transac   coed
   ggn is loactionserify tra V

      //2)Be(.tots)torSeace.facilitaalanpdatedB    expect(u
  .id)nce(testUserlletBalaetWavice.geWalletSert Resourcaiance = awpdatedBalt uns    co
  is updatedbalance / Verify       /(2)

nce).toBemainingBala(result.re expect  e)
   s).toBe(trusuccespect(result.   ex)

   .idstProjectser.id, te(testUSeatlitatoreFaciconsumetService.ourceWallit Res awanst result =
      coeatator ssume facilit/ Con    /
  toBe(3)
ats).acilitatorSelance.ftialBaect(ini    expid)
  ser.alance(testUletBalrvice.getWWalletSeesource= await Rce lBalanonst initia
      cc () => {', asyn facilitatorngnvitin ir seat wheilitatosume faconit('should c
     () => {w',tion Floe('Invitadescrib
    })

    })
)hers).toBe(0ctVoucce.projealanect(b
      expestUser.id)tBalance(tWalletService.getWallerceawait Resounce = t balans
      cot 0mains ace re balan Verify     //r')

 hevouct project_nsufficienntain('IoCor).tesult.errot(r  expec    e)
.toBe(falscess)t(result.sucexpec      
)
roject'id, 'new-ptUser.esr(tchejectVoue.consumeProalletServicesourceWlt = await R const resur
     ther vouchenoto consume a  // Try    }

       ect-${i}`)
r.id, `projher(testUsejectVoucmeProsuervice.conalletSrceWsou Re      await; i++) {
   5= 0; i <(let i 
      for chersect vouojl prsume al // Con {
     async () =>ouchers', cient vinsuffit when ojecte prcreal to  faiuldit('sho  
  
    })
d)tProject.iId).toBe(teson?.projectnTransacticonsumptio    expect(e(-1)
  ).toBntamoution?.ionTransact(consumpt expec)
     ct_voucher'toBe('projeType).n?.resourceransactioconsumptionTexpect()
      toBeDefined(saction).Tranconsumptionexpect(')
       'consumenType ===transactio => t..find(transactionstion = tnsacsumptionTra   const con
      
   ptionconsum + 1  3 initial) //Length(4ves).toHaon(transactiect      expd)
er.iUstesty(ionHistorransacttTvice.getSerleesourceWal= await Rransactions      const tged
 is logion ransact Verify t  //(4)

    uchers).toBee.projectVoncdBalapect(updateex
      er.id)testUsance(BaletlletWatService.grceWalleit Resou = awaatedBalanceconst upded
       is updatnceify bala// Ver4)

      ce).toBe(alanningBresult.remaipect(
      exBe(true).success).toxpect(result     e.id)

 ctProjetestestUser.id, tVoucher(tsumeProjecervice.coneWalletSwait Resourc result = a     const
 voucherume project  // Cons  

   (5)rs).toBectVouchelance.projenitialBat(ixpec     eer.id)
 stUsetBalance(teetWallrvice.gletSe ResourceWale = awaitancialBalinitnst   co => {
    sync ()t', aojecg pren creatinwhoucher me project vshould consuit('  () => {
  ow',  Fl Creatione('Projectdescrib

  
  })y()el.db.destroait BaseModaw    ).del()
rs'('useodel.dbeMit Bas awa   ()
ects').delb('proj BaseModel.dait   awl()
 ations').dedb('invitdel.eMoit Bas    awa).del()
ce_wallets'r_resourel.db('useBaseModait el()
    awons').dtit_transacb('seaodel.deM Basn
    awaitconnectiose database nd cloClean up a  // ) => {
  ync (ll(as afterA

   })
  })id
  er.orId: testUsilitat   facests',
   ntegration troject for iest piption: 'T descr   t',
  Test Projec    name: '  
reate({odel.cProjectMt t = awaitestProjecct
     test proje/ Create   /})

 
    : 2eatstorytellerS  s    eats: 3,
rSacilitato    f
  uchers: 5,rojectVo
      p, testUser.idd:erI us     ({
ateWalletreletService.cResourceWal await let =    testWal resources
th initialwallet wite test 
    // Crea })
   '
t-auth-iderId: 'tesvid authPro   ,
   'email'er:  authProvid
    ',User 'Test      name:
 com',example.est@'tail:    em  .create({
 rModel await UsestUser =user
    tee test / Creat    /()

rs').dell.db('usedeit BaseMo awa  )
 cts').del(db('projeBaseModel.it    awa()
 ns').deltatiob('invidel.d BaseMo  await()
  ).delets'allsource_wer_redel.db('us BaseMo    awaitdel()
sactions').t_tranel.db('seaeMod await Basbase
   p data// Clean u   c () => {
 asynbeforeEach( })

  atest()
 migrate.ldb.Model.se   await Baion
 e connecttabasp test da// Setu=> {
    ll(async () eforeA
  bWallet
esourceserRallet: U  let testW: Project
stProject  let te
: Useret testUser {
  l =>', ()ration Testslet IntegWale('Resource 
describ
ypes'ed/taga/sharm '@s
} froaseRequestPackagePurchequest,
  onRrceConsumptisou
  RerceWallet,sou UserReoject,
  Pr
  
  User,mport type {'
imodels/base../../ } from 'delMot { Basepor
iminvitation'odels/../mfrom '../l } tationModeport { Inviroject'
im/p../../modelsel } from 'rojectModport { P/user'
imodels../m } from '../delrMomport { Useion'
ictat-transamodels/se../../ } from 'ctionModeltTransaimport { Seaallet'
-wresourceodels/om '../../model } frlletMsourceWaort { Reice'
impllet-servesource-wavices/rerrom '../../sService } fourceWalletmport { Res */

il database
 rea withlows fsactionwallet tranests for end t End-to- *ts
ation Tesntegr Iurce Wallet*
 * Reso/*