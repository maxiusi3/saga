# 故事图片上传功能 - 测试说明

## 当前实现状态

### ✅ 已实现的功能

1. **后端 API** - 100% 完成
   - 所有图片上传、删除、管理 API 已实现
   - Supabase Storage 集成完成
   - 权限控制和 RLS 策略已配置

2. **前端组件** - 100% 完成
   - ImageUploader 组件已创建
   - ImageGallery 组件已创建
   - ImageLightbox 组件已创建
   - CommentImageSelector 组件已创建
   - TranscriptEditModal 组件已创建

3. **集成** - 部分完成
   - ✅ ImageUploader 已集成到录制界面（reviewing 状态）
   - ⚠️ ImageGallery 已集成到故事详情页（需要验证）
   - ⚠️ 评论图片上传已集成（需要验证）

---

## 如何测试需求 1: 故事片段图片上传

### 前提条件
- 已登录系统
- 有一个活跃的项目
- 浏览器允许麦克风权限

### 测试步骤

1. **进入录制页面**
   - 导航到项目页面
   - 点击"录制新故事"按钮

2. **开始录音**
   - 点击"开始录制"按钮
   - 允许麦克风权限（如果提示）
   - 说一些话（至少 5 秒）

3. **停止录音**
   - 点击"停止录制"按钮
   - 系统会进入"审核"状态

4. **验证图片上传功能** ⭐ 关键步骤
   - 在审核页面，你应该看到：
     - ✅ 图片上传区域
     - ✅ "点击或拖拽图片到此处"的提示
     - ✅ 支持的格式说明
     - ✅ 最多 6 张图片的限制说明

5. **上传图片**
   - 点击上传区域或拖拽图片文件
   - 选择 1-6 张图片（JPG, PNG, GIF, WEBP）
   - 每张图片不超过 10MB

6. **验证图片预览**
   - 上传后应该看到图片预览
   - 每张图片有删除按钮
   - 显示已上传数量

7. **提交故事**
   - 点击"提交"按钮
   - 图片应该与故事一起保存

### 预期结果

| 验收标准 | 预期行为 |
|---------|---------|
| 1.1 显示上传区域 | 在审核状态下看到图片上传组件 |
| 1.2 打开文件选择 | 点击后打开文件选择对话框 |
| 1.3 验证格式 | 只接受 JPG, PNG, GIF, WEBP |
| 1.4 验证大小 | 拒绝超过 10MB 的文件 |
| 1.5 显示错误 | 无效文件显示错误提示 |
| 1.6 显示预览 | 上传后显示图片预览 |
| 1.7 多张上传 | 可以上传多张图片 |
| 1.8 数量限制 | 最多 6 张，超过后禁用上传 |
| 1.9 取消删除 | 取消录音时删除已上传图片 |
| 1.10 提交上传 | 提交时图片保存到 Supabase |

---

## 如何测试需求 4: 故事图片相册展示

### 测试步骤

1. **创建带图片的故事**
   - 按照需求 1 的步骤创建一个包含图片的故事

2. **进入故事详情页**
   - 在项目页面点击故事
   - 或直接导航到故事详情页

3. **验证图片相册**
   - 应该看到"图片相册"区域
   - 显示所有上传的图片
   - 图片以网格形式排列

4. **点击图片**
   - 点击任意图片
   - 应该打开 lightbox 大图查看
   - 可以使用左右箭头导航

5. **验证图片管理**（如果是 storyteller）
   - 悬停在图片上
   - 应该看到管理按钮：
     - 设为主图片
     - 删除
     - 拖拽排序

### 预期结果

| 验收标准 | 预期行为 |
|---------|---------|
| 4.1 显示相册 | 故事详情页有图片相册区域 |
| 4.2 展示所有图片 | 所有图片以网格形式显示 |
| 4.3 显示来源标签 | 每张图片显示来源（片段序号或"评论补充"）|
| 4.4 点击大图 | 点击图片打开 lightbox |
| 4.5 导航按钮 | Lightbox 有左右导航按钮 |
| 4.6 标记主图片 | 主图片有特殊标记 |
| 4.7 无图片隐藏 | 没有图片时不显示相册区域 |
| 4.8 高亮片段图片 | 切换片段时高亮对应图片 |

---

## 如何测试需求 2: 评论图片上传

### 测试步骤

1. **进入故事详情页**
   - 打开任意故事

2. **找到评论输入区域**
   - 滚动到页面底部
   - 找到"添加评论"区域

3. **验证图片上传按钮**
   - 应该看到图片上传区域
   - 在评论文本框下方

4. **上传图片**
   - 点击上传区域
   - 选择 1-6 张图片
   - 验证预览显示

5. **提交评论**
   - 输入评论文本
   - 点击"提交评论"
   - 图片应该与评论一起显示

### 预期结果

| 验收标准 | 预期行为 |
|---------|---------|
| 2.1 显示上传按钮 | 评论区域有图片上传功能 |
| 2.2-2.10 | 与需求 1 类似的验证流程 |

---

## 已知问题

### 🔴 严重问题

1. **原始录音缺失**
   - 症状：创建故事后，原始录音无法播放
   - 影响：核心功能受损
   - 状态：需要修复

2. **Followup 录音无法播放**
   - 症状：Followup 故事有录音但无法播放
   - 影响：后续录音功能受损
   - 状态：需要修复

### ⚠️ 需要验证的功能

1. **图片上传是否在审核阶段显示**
   - 需要完成完整的录音流程来验证
   - 代码已实现，但需要实际测试

2. **图片相册是否正确显示**
   - 需要创建带图片的故事来验证
   - 代码已实现，但需要实际测试

3. **评论图片上传是否正常工作**
   - 需要在故事详情页测试
   - 代码已实现，但需要实际测试

---

## 调试提示

### 如果看不到图片上传功能

1. **检查录制状态**
   - 图片上传只在"reviewing"状态显示
   - 必须完成录音才能看到

2. **检查浏览器控制台**
   - 打开开发者工具（F12）
   - 查看 Console 标签页
   - 查找任何错误消息

3. **检查网络请求**
   - 打开开发者工具的 Network 标签页
   - 查看是否有失败的 API 请求
   - 检查 Supabase Storage 请求

### 如果图片上传失败

1. **检查文件格式**
   - 确保是 JPG, PNG, GIF, 或 WEBP
   - 检查文件扩展名

2. **检查文件大小**
   - 确保每张图片不超过 10MB
   - 尝试压缩图片

3. **检查网络连接**
   - 确保网络稳定
   - 检查是否有防火墙阻止

4. **检查 Supabase 配置**
   - 验证 Storage bucket 存在
   - 检查 RLS 策略是否正确

---

## 下一步

1. **等待 Vercel 部署完成**（约 2-3 分钟）
2. **刷新页面**以加载最新代码
3. **按照上述步骤测试**每个需求
4. **记录测试结果**
5. **报告任何问题**

---

## 技术细节

### 代码位置

- **录制界面**: `packages/web/src/components/recording/recording-interface.tsx`
  - ImageUploader 在第 372 行
  - 只在 `recordingState === 'reviewing'` 时显示

- **故事详情页**: `packages/web/src/components/stories/story-detail-page.tsx`
  - ImageGallery 在第 448 行
  - 评论图片上传在第 654 行

- **API 端点**:
  - POST `/api/stories/[storyId]/transcripts/[transcriptId]/images` - 上传故事图片
  - GET `/api/stories/[storyId]/images` - 获取故事图片
  - POST `/api/interactions/[interactionId]/images` - 上传评论图片

### 状态管理

```typescript
// 录制界面
const [uploadedImages, setUploadedImages] = useState<Array<{ 
  id: string; 
  file: File; 
  preview: string 
}>>([])

// 故事详情页
const [storyImages, setStoryImages] = useState<StoryImage[]>([])
const [interactionImages, setInteractionImages] = useState<InteractionImage[]>([])
const [commentImages, setCommentImages] = useState<Array<{ 
  id: string; 
  file: File; 
  preview: string 
}>>([])
```

---

**最后更新**: 2025-01-11
**部署状态**: 等待 Vercel 自动部署
**测试状态**: 待测试
